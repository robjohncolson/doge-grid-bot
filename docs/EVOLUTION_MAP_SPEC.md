# Evolution Map UI Spec (2D Canvas)

## Goal

Render a user-friendly 2D map that links:

- the state machine structure (`STATE_MACHINE.md`)
- the feature tree inferred from commit history
- the full timeline of commits (EST / America-New_York)

The map should answer:

- "What features exist?"
- "Which states did each feature change?"
- "When did each change land?"

## Primary Views

1. `Map View` (default)
- Center canvas with lanes and nodes.
- Time on x-axis, system lane on y-axis.
- Uses pan/zoom and hover highlights.

2. `Timeline View` (compact strip)
- Bottom scrubber with commit density bars.
- Drag handle to filter visible time window.

3. `Details View` (right panel)
- Selected node metadata.
- For commits: hash, EST timestamp, message, matched feature, state sections.
- For features: first/last commit, commit count, state sections touched.
- For state sections: linked features and linked commits.

## Layout

1. Left rail (`280px`)
- Search box.
- Filter groups: lane, feature, tag, deprecation candidates.
- Toggle: show `factory` and `telegram` branches.

2. Main canvas (fluid width)
- Top ruler: EST timeline tick marks.
- Middle map: lanes, links, nodes.
- Bottom ruler: timeline scrubber.

3. Right panel (`360px`)
- Detail card with tabs: `Summary`, `Commits`, `Links`.

## Visual Grammar

1. Lanes
- Horizontal bands (`Lifecycle`, `Pair Core`, `Recovery`, `Swarm`, `Risk`, `AI/Control`, `UX`).
- Lane labels fixed on the left edge.

2. Nodes
- `State Section` node: rounded rectangle.
- `Feature` node: pill/capsule with heavier border.
- `Commit` node: small circle.

3. Links
- `state_transition`: dashed neutral line.
- `feature_affects_state`: solid colored line from feature to section.
- `commit_implements_feature`: thin line from commit to feature.

4. Color
- One deterministic color per lane.
- Commit inherits feature/lane color.
- Deprecated-candidate branch uses 40% opacity by default.

## Interactions

1. Hover
- Highlights all first-degree links.
- Tooltip with ID + label + timestamp (for commits).

2. Click
- Locks selection.
- Populates right panel.

3. Ctrl/Cmd-click
- Multi-select and union highlight.

4. Timeline scrub
- Filters commit nodes by selected time range.
- Feature/state nodes stay visible, but dim when no commits in window.

5. Filters
- Filtering is additive.
- Keep layout stable; hidden nodes fade/disable pointer events.

## Data Contract

Frontend expects one JSON document generated by `tools/build_evolution_map.py`.

Top-level shape:

```json
{
  "meta": {},
  "lanes": [],
  "state_sections": [],
  "features": [],
  "commits": [],
  "links": [],
  "feature_tree": {}
}
```

Required fields:

1. `lanes[]`
- `id`, `label`, `order`

2. `state_sections[]`
- `id`, `section`, `title`, `lane_id`

3. `features[]`
- `id`, `label`, `lane_id`, `order`, `deprecated_candidate`, `state_sections`

4. `commits[]`
- `id`, `hash`, `index`, `timestamp_unix`, `timestamp_local`, `subject`
- `feature_id`, `lane_id`, `state_section_ids`, `matched_keywords`

5. `links[]`
- `id`, `source`, `target`, `type`

6. `feature_tree`
- Tree object with root and ordered child references.

## Coordinate Strategy

1. `x`
- Linear scale of `timestamp_unix`.
- Optional jitter for overlapping commit dots on same timestamp.

2. `y`
- Lane band center for features/commits.
- State section nodes pinned near lane origin area.

3. Layout determinism
- Sort features by `order`.
- Sort commits by chronological `index`.
- Preserve stable node IDs for smooth transitions.

## Performance Targets

1. Initial load under 100 ms for <= 500 commits.
2. Hover interaction under 16 ms frame budget.
3. Use offscreen caching for static lane backgrounds.

## Accessibility

1. Keyboard focus traversal for node list.
2. High-contrast mode toggle.
3. Tooltip text mirrored in right-panel focus region.

## Implementation Plan

1. Generate data:
- `python3 tools/build_evolution_map.py --out docs/evolution_map.data.json`

2. Build render shell:
- Canvas stage + left/right panels + timeline scrubber.

3. Wire interactions:
- hover, click, multi-select, filter, scrub.

4. Add polish:
- animated transitions, opacity blending, persistent URL state.

